version: "3.8"

networks:
  wms-network:
    driver: bridge

volumes:
  caddy_data:
  caddy_config:

services:
  web:
    build:
      context: .
    image: wms:amd64
    ports:
      - "8000:8000"
    # Load all common env vars from Lightsail containers.json
    env_file:
      - .cache/.env
    # Mount local directories for rapid development
    volumes:
      - ./core:/app/core
      - ./lib:/app/lib
      - ./schemas:/app/schemas
      - ./staticfiles:/app/staticfiles
      - ./wms:/app/wms
    entrypoint:
      - "/app/docker-entrypoint.sh"
    networks:
      - wms-network

  caddy:
    image: caddy:2-alpine
    ports:
      - "8080:8080"
      - "8443:8443"
    environment:
      - DOMAIN=${DOMAIN:-dev.wms.local}
      - LOCAL_IP=${LOCAL_IP:-192.168.68.54}
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - ./deploy/caddy-local.crt:/etc/caddy/certs/caddy-local.crt:ro
      - ./deploy/caddy-local.key:/etc/caddy/certs/caddy-local.key:ro
      - caddy_data:/data
      - caddy_config:/config
    networks:
      - wms-network
    depends_on:
      - web
