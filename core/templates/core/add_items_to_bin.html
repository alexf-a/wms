{% extends "core/base.html" %}
{% load static %}

{% block title %}Add Item - WMS{% endblock %}

{% block content %}
<div class="m3-page-shell add-item-flow">
    
    <!-- Snackbar for error messages -->
    <div id="error-snackbar" class="m3-snackbar" role="alert" aria-live="polite">
        <span id="error-snackbar-text" class="m3-snackbar-text"></span>
        <button type="button" id="error-snackbar-dismiss" class="m3-snackbar-action" aria-label="Dismiss">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
            </svg>
        </button>
    </div>
    
    <!-- Single form wrapping everything -->
    <form method="post" enctype="multipart/form-data" id="item-form" class="m3-form-vertical">
        {% csrf_token %}
        
        <!-- Hero Action: Image Upload Section -->
        <section class="hero-upload-section">
            <div class="hero-upload-container">
                
                <!-- Large Camera Upload Button -->
                <div class="hero-upload-button-wrapper">
                    <input type="file" id="hero-image-input" name="image" accept="image/*" class="visually-hidden-input" aria-label="Upload item image for AI analysis">
                    <label for="hero-image-input" class="hero-upload-btn" role="button" tabindex="0" aria-label="Upload item image">
                        <div class="hero-upload-icon">
                            <svg width="64" height="64" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 15.2l-2.5-2.5 1.4-1.4.6.6V8h1.5v3.9l.6-.6 1.4 1.4-2.5 2.5zM21 5v14c0 1.1-.9 2-2 2H5c-1.1 0-2-.9-2-2V5c0-1.1.9-2 2-2h14c1.1 0 2 .9 2 2zM7 18h10V6H7v12z"/>
                                <path d="M12 7c-1.1 0-2 .9-2 2 0 .37.11.7.28 1L12 11.72 13.72 10c.17-.3.28-.63.28-1 0-1.1-.9-2-2-2z"/>
                            </svg>
                        </div>
                        <span class="hero-upload-text md-typescale-title-large">Take Photo or Upload</span>
                        <span class="hero-upload-subtext md-typescale-body-medium">AI will auto-fill details</span>
                    </label>
                </div>
                
                <!-- Skip Option -->
                <div class="hero-skip-wrapper">
                    <button type="button" id="skip-to-manual" class="skip-link">
                        <span>Skip and enter manually</span>
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/>
                        </svg>
                    </button>
                </div>
            </div>
        </section>

        <!-- Manual Form Section (Initially Hidden) -->
        <section id="form-section" class="form-section">
            <!-- Image Preview (shown after upload) -->
            <div id="image-preview-container" class="image-preview-container">
                <div class="m3-card m3-card--outlined">
                    <div class="m3-card__content image-preview-flex">
                        <img id="preview-image" src="" alt="Item preview" class="preview-thumbnail">
                        <div class="image-preview-flex-fill">
                            <div class="md-typescale-body-medium image-preview-text">
                                Image uploaded
                            </div>
                        </div>
                        <label for="hero-image-input" class="m3-button m3-button-outlined" role="button" tabindex="0">
                            <span class="m3-button-label">Change</span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Loading State -->
            <div id="loading-indicator" class="loading-indicator">
                <div class="loading-spinner"></div>
                <p class="md-typescale-body-large">AI is analyzing your image...</p>
            </div>

            <!-- Form Card -->
            <div id="form-card" class="m3-card m3-card--filled">
                <div class="m3-card__content">
                    <h2 class="md-typescale-title-large m3-card__title form-card-title">
                        Item Details
                    </h2>
                    
                    <!-- Name Field -->
                    <div class="m3-form-field{% if form.name.errors %} m3-form-field--error{% endif %}">
                        <label for="id_name" class="m3-form-label">Name</label>
                        <input type="text" name="name" id="id_name" class="m3-text-field{% if form.name.errors %} m3-text-field--error{% endif %}" value="{{ form.name.value|default:'' }}" required>
                        {% if form.name.errors %}
                        <span class="m3-form-error">{{ form.name.errors.0 }}</span>
                        {% endif %}
                    </div>
                    
                    <!-- Description Field -->
                    <div class="m3-form-field">
                        <label for="id_description" class="m3-form-label">Description</label>
                        <textarea name="description" id="id_description" class="m3-text-field" rows="4">{{ form.description.value|default:'' }}</textarea>
                    </div>
                    
                    <!-- Bin Field -->
                    <div class="m3-form-field">
                        <label for="id_bin" class="m3-form-label">Bin</label>
                        <select name="bin" id="id_bin" class="m3-text-field" required>
                            <option value="">Select a bin...</option>
                            {% for bin in bins %}
                            <option value="{{ bin.id }}"{% if form.bin.value|stringformat:"s" == bin.id|stringformat:"s" %} selected{% endif %}>{{ bin.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="m3-card__actions form-actions-spacing">
                        <button type="submit" class="m3-button m3-button-filled m3-button-standard">
                            <svg class="m3-button-icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M19 13H13V19H11V13H5V11H11V5H13V11H19V13Z"/>
                            </svg>
                            <span class="m3-button-label">Add Item</span>
                        </button>
                        <a href="{% url 'list_bins' %}" class="m3-button m3-button-tonal m3-button-standard">
                            <svg class="m3-button-icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
                            </svg>
                            <span class="m3-button-label">Cancel</span>
                        </a>
                    </div>
                </div>
            </div>
        </section>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'core/js/add_items_flow.js' %}?v=4"></script>
<script>
// Initialize snackbar with server-side errors if present
document.addEventListener('DOMContentLoaded', function() {
    {% if form.errors %}
    // Show form section if there are errors
    const formSection = document.getElementById('form-section');
    const formCard = document.getElementById('form-card');
    if (formSection) formSection.style.display = 'block';
    if (formCard) formCard.style.display = 'block';
    
    // Show snackbar with error message
    {% for field, errors in form.errors.items %}
    {% for error in errors %}
    showErrorSnackbar("{{ error|escapejs }}");
    {% endfor %}
    {% endfor %}
    {% endif %}
});

function showErrorSnackbar(message) {
    const snackbar = document.getElementById('error-snackbar');
    const snackbarText = document.getElementById('error-snackbar-text');
    const dismissBtn = document.getElementById('error-snackbar-dismiss');
    
    if (snackbar && snackbarText) {
        snackbarText.textContent = message;
        snackbar.classList.add('m3-snackbar--visible');
        
        // Auto-dismiss after 6 seconds
        const timeout = setTimeout(() => {
            snackbar.classList.remove('m3-snackbar--visible');
        }, 6000);
        
        // Manual dismiss
        if (dismissBtn) {
            dismissBtn.onclick = () => {
                clearTimeout(timeout);
                snackbar.classList.remove('m3-snackbar--visible');
            };
        }
    }
}
</script>
{% endblock %}